name: Build Multi WiFi Drivers (ARM64) with Auto Kernel Fallback

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: 'URL Kernel Repo'
        required: true
        default: 'https://github.com/kamu/openwrt-kernel.git'
      kernel_branch:
        description: 'Branch Kernel'
        required: true
        default: 'main'
      driver_urls:
        description: 'Daftar Driver (format: url@branch), pisah baris'
        required: true
        default: |
          https://github.com/kamu/rtl8189fs.git@main
          https://github.com/kamu/rtl8821cu.git@master
      Lokasi:
        description: 'Daftar Driver (format: url@branch), pisah baris'
        required: true
        default: 5.4/config
        
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo Ini
      uses: actions/checkout@v4

    - name: Install Toolchain
      run: |
        sudo apt update
        sudo apt install -y gcc-aarch64-linux-gnu make bc bison flex libssl-dev git

    - name: Clone Kernel
      run: |
        git clone --depth=1 --branch "${{ github.event.inputs.kernel_branch }}" \
          "${{ github.event.inputs.kernel_repo }}" kernel
        cp "${{ github.event.inputs.Lokasi }}" kernel/.config || true

    - name: Cek Module.symvers (jika ada di repo)
      id: check_symvers
      run: |
        if [ -f 5.4/Module.symvers ]; then
          echo "SYMVERS_FOUND=true" >> $GITHUB_ENV
          cp 5.4/Module.symvers kernel/
        else
          echo "SYMVERS_FOUND=false" >> $GITHUB_ENV
        fi

    - name: Build Kernel (jika tidak ada symvers)
      if: env.SYMVERS_FOUND == 'false'
      run: |
        cd kernel
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc)
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules

    - name: Prepare Kernel
      run: |
        cd kernel
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules_prepare
        
    - name: Build Semua Driver
      run: |
        mkdir -p output
        echo "${{ github.event.inputs.driver_urls }}" | while IFS= read -r line; do
          repo_url=$(echo "$line" | cut -d'@' -f1)
          branch=$(echo "$line" | cut -d'@' -f2)
          name=$(basename "$repo_url" .git)
          echo ">> Cloning $name from $repo_url @ $branch"
          git clone --depth=1 --branch "$branch" "$repo_url" "$name"
          echo ">> Building $name"
          ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- EXTRA_CFLAGS="-Wno-error" \
            make -C kernel M=$PWD/$name modules
          cp $name/*.ko output/${name}-arm64.ko || true
        done
        cp kernel/Module.symvers output/ || true
        tar -czvf output/all-drivers-arm64.tar.gz -C output . || true

    - name: Upload ke GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "driver-build-${{ github.run_number }}"
        files: |
          output/*.ko
          output/Module.symvers
          output/all-drivers-arm64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


    
